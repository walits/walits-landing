<h1 class="text-4xl font-bold mb-6">Withdrawal Flow</h1>

        <div class="bg-red-50 border-l-4 border-red-500 p-6 mb-6">
          <p class="font-semibold text-lg mb-2">Immediate Balance Hold</p>
          <p class="mb-3">To prevent double-spending, withdrawal requests <strong>immediately lock funds</strong>:</p>
          <ul class="list-disc list-inside space-y-1">
            <li><code class="bg-red-100 px-2 py-1 rounded">availableBalance</code> decreases immediately</li>
            <li><code class="bg-red-100 px-2 py-1 rounded">pendingWithdrawalBalance</code> increases immediately</li>
            <li>Second withdrawal request for same funds will fail (insufficient available balance)</li>
            <li>If withdrawal fails, balance is automatically restored (rollback)</li>
          </ul>
          <p class="mt-3 text-red-800">See <a href="#withdrawal-handling" class="underline">Balance Management: Withdrawal Handling</a> for technical details.</p>
        </div>

        <h2 class="text-2xl font-semibold mt-8 mb-4">Step-by-Step Process</h2>
        <div class="space-y-6">
          <div class="border-l-4 border-blue-500 pl-6">
            <h3 class="text-xl font-semibold mb-2">Step 1: Request Withdrawal (Balance Hold)</h3>
            <pre><code class="language-bash">
POST /wallets/custody/{walletId}/withdraw
X-API-Key: bbit_live_xxx
X-API-Secret: sk_xxx

{
  "toAddress": "0xRECIPIENT_ADDRESS",
  "amount": "5.0",
  "memo": "Withdrawal for user_12345"
}

# Response
{
  "approvalRequestId": "apr_xyz789",
  "status": "PENDING",
  "requiredApprovals": 2,
  "currentApprovals": 0,
  "amount": "5.0",
  "fromAddress": "0xOMNIBUS_ADDRESS",
  "toAddress": "0xRECIPIENT_ADDRESS",
  "message": "Waiting for 2 approvals"
}

# IMPORTANT: Balance hold happens IMMEDIATELY
# - availableBalance -= 5.0 (prevents double-spend)
# - pendingWithdrawalBalance += 5.0
# - WITHDRAWAL_REQUESTED webhook sent
            </code></pre>
          </div>

          <div class="border-l-4 border-green-500 pl-6">
            <h3 class="text-xl font-semibold mb-2">Step 2: Policy Validation</h3>
            <pre><code class="language-plaintext">
System checks:
✅ Is toAddress in whitelist? (if whitelistOnly = true)
✅ Daily limit check: 5.0 < 50.0 (maxDailyLimit)
✅ Monthly limit check: 5.0 < 2000.0 (maxMonthlyLimit)
✅ Sufficient balance: 5.0 < 100.0 (omnibus balance)
→ All checks passed, approval workflow starts
            </code></pre>
          </div>

          <div class="border-l-4 border-purple-500 pl-6">
            <h3 class="text-xl font-semibold mb-2">Step 3: Approval Process</h3>
            <pre><code class="language-bash">
# Admin 1 approves
POST /approvals/{approvalRequestId}/approve
X-API-Key: admin1_key
{
  "comment": "Verified with user"
}
→ currentApprovals: 1/2

# Admin 2 approves
POST /approvals/{approvalRequestId}/approve
X-API-Key: admin2_key
{
  "comment": "Approved"
}
→ currentApprovals: 2/2 ✅
→ Status: APPROVED
            </code></pre>
          </div>

          <div class="border-l-4 border-orange-500 pl-6">
            <h3 class="text-xl font-semibold mb-2">Step 4: MPC Signature Generation</h3>
            <pre><code class="language-plaintext">
→ Walits initiates MPC signing ceremony
→ Your key share (1/3) + Walits HSM (1/3) = 2/3 ✅
→ CGGMP24 threshold signature generated (~1.5 seconds)
→ Transaction built and signed
            </code></pre>
          </div>

          <div class="border-l-4 border-red-500 pl-6">
            <h3 class="text-xl font-semibold mb-2">Step 5: Blockchain Broadcast & Tracking</h3>
            <pre><code class="language-json">
// Transaction broadcast to Ethereum (walits-provider)
{
  "txHash": "0x789def...",
  "from": "0xOMNIBUS_ADDRESS",
  "to": "0xRECIPIENT_ADDRESS",
  "amount": "5.0 ETH",
  "gasPrice": "30 gwei",
  "status": "pending"
}

// Webhook: Transaction confirmed (after 6-12 confirmations)
{
  "event": "withdrawal.confirmed",
  "data": {
    "approvalRequestId": "apr_xyz789",
    "txHash": "0x789def...",
    "status": "confirmed",
    "confirmations": 6,  // Sepolia: 6, Mainnet: 12
    "timestamp": "2024-12-09T11:00:00Z"
  }
}
            </code></pre>
          </div>

          <div class="border-l-4 border-gray-500 pl-6">
            <h3 class="text-xl font-semibold mb-2">Step 5.5: walits-provider Withdrawal Tracking</h3>
            <p class="mb-3">walits-provider is a NestJS-based RPC Router and withdrawal tracking system:</p>
            <ul class="list-disc list-inside space-y-2 mb-3">
              <li><strong>Broadcast</strong>: Sends transaction via eth_sendRawTransaction after MPC signing</li>
              <li><strong>In-Memory Map</strong>: Stores pending withdrawals in memory</li>
              <li><strong>Polling every 30s</strong>: Queries transaction status via eth_getTransactionReceipt</li>
              <li><strong>Confirmation Calculation</strong>: confirmations = latestBlock - txBlock + 1</li>
              <li><strong>1 conf</strong>: MINED status (logs only, no webhook)</li>
              <li><strong>6+ conf</strong>: CONFIRMED status (deducts pending balance, sends webhook)</li>
              <li><strong>Revert/Dropped</strong>: FAILED status (rolls back balance, sends webhook)</li>
            </ul>
          </div>
        </div>

        <h2 class="text-2xl font-semibold mt-8 mb-4">Withdrawal States</h2>
        <table class="w-full border border-gray-200 mb-6">
          <thead class="bg-gray-50">
            <tr>
              <th class="border border-gray-200 px-4 py-3 text-left">Status</th>
              <th class="border border-gray-200 px-4 py-3 text-left">Description</th>
              <th class="border border-gray-200 px-4 py-3 text-left">Next Action</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td class="border border-gray-200 px-4 py-2 font-mono text-sm bg-yellow-50">PENDING</td>
              <td class="border border-gray-200 px-4 py-2">Waiting for approvals</td>
              <td class="border border-gray-200 px-4 py-2">Admins need to approve</td>
            </tr>
            <tr>
              <td class="border border-gray-200 px-4 py-2 font-mono text-sm bg-blue-50">APPROVED</td>
              <td class="border border-gray-200 px-4 py-2">Threshold met, generating signature</td>
              <td class="border border-gray-200 px-4 py-2">Automatic (MPC signing)</td>
            </tr>
            <tr>
              <td class="border border-gray-200 px-4 py-2 font-mono text-sm bg-purple-50">BROADCASTING</td>
              <td class="border border-gray-200 px-4 py-2">Transaction sent to blockchain</td>
              <td class="border border-gray-200 px-4 py-2">Wait for confirmations</td>
            </tr>
            <tr>
              <td class="border border-gray-200 px-4 py-2 font-mono text-sm bg-green-50">CONFIRMED</td>
              <td class="border border-gray-200 px-4 py-2">Transaction confirmed on-chain (6-12 confirmations)</td>
              <td class="border border-gray-200 px-4 py-2">Complete ✅</td>
            </tr>
            <tr>
              <td class="border border-gray-200 px-4 py-2 font-mono text-sm bg-red-50">REJECTED</td>
              <td class="border border-gray-200 px-4 py-2">Admin(s) rejected the request</td>
              <td class="border border-gray-200 px-4 py-2">User must create new request</td>
            </tr>
          </tbody>
        </table>