<h1 class="text-4xl font-bold mb-6">Deposit Flow</h1>

        <div class="bg-blue-50 border-l-4 border-blue-500 p-6 mb-6">
          <p class="font-semibold text-lg mb-2">2-Stage Deposit Process</p>
          <p class="mb-3">Walits uses a two-stage confirmation process to protect against blockchain reorganizations:</p>
          <ul class="list-disc list-inside space-y-1">
            <li><strong>Stage 1 (DEPOSIT_DETECTED)</strong>: 1 confirmation - Notification only, no balance change</li>
            <li><strong>Stage 2 (DEPOSIT_CONFIRMED)</strong>: 6-12 confirmations (network-dependent: Sepolia 6, Mainnet 12) - Balance updated, safe to credit user</li>
          </ul>
          <p class="mt-3 text-blue-800">See <a href="#deposit-handling" class="underline">Balance Management: Deposit Handling</a> for technical details.</p>
        </div>

        <h2 class="text-2xl font-semibold mt-8 mb-4">Step-by-Step Process</h2>
        <div class="space-y-6">
          <div class="border-l-4 border-blue-500 pl-6">
            <h3 class="text-xl font-semibold mb-2">Step 1: Create Virtual Account</h3>
            <pre><code class="language-bash">
POST /wallets/custody/{walletId}/virtual-accounts
X-API-Key: bbit_live_xxx
X-API-Secret: sk_xxx

{
  "userId": "user_12345",
  "label": "User John Doe - ETH Account"
}

# Response
{
  "virtualAccountId": "va_abc123",
  "depositAddress": "0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb",
  "walletId": "wal_abc123",
  "userId": "user_12345",
  "balance": "0.0"
}
            </code></pre>
          </div>

          <div class="border-l-4 border-green-500 pl-6">
            <h3 class="text-xl font-semibold mb-2">Step 2: User Sends Funds</h3>
            <pre><code class="language-plaintext">
User sends 10 ETH to: 0x742d35Cc6634C0532925a3b844Bc9e7595f0bEb
→ Transaction included in block
→ xScanner detects deposit (block polling every 10 seconds)
            </code></pre>
          </div>

          <div class="border-l-4 border-gray-500 pl-6">
            <h3 class="text-xl font-semibold mb-2">Step 2.5: xScanner Blockchain Monitoring</h3>
            <p class="mb-3">xScanner is a Rust-based blockchain monitoring system that detects deposits:</p>
            <ul class="list-disc list-inside space-y-2 mb-3">
              <li><strong>Block Polling</strong>: Checks new blocks every 10 seconds via eth_getBlockByNumber</li>
              <li><strong>UnconfirmedDeposit DB</strong>: Stores detected deposits in DB to track confirmations</li>
              <li><strong>1 conf reached</strong>: Sends DEPOSIT_DETECTED webhook</li>
              <li><strong>6+ conf reached</strong>: Sends DEPOSIT_CONFIRMED webhook, removes from DB</li>
            </ul>
          </div>

          <div class="border-l-4 border-yellow-500 pl-6">
            <h3 class="text-xl font-semibold mb-2">Step 3: DEPOSIT_DETECTED (1 confirmation)</h3>
            <pre><code class="language-json">
// Webhook sent - notification only, NO balance change yet
{
  "event": "DEPOSIT_DETECTED",
  "data": {
    "accountId": "acc_123",
    "amount": "10.0",
    "txHash": "0x123abc...",
    "confirmations": 1
  }
}

// Recommended action: Show "Pending deposit" in UI
            </code></pre>
          </div>

          <div class="border-l-4 border-purple-500 pl-6">
            <h3 class="text-xl font-semibold mb-2">Step 4: DEPOSIT_CONFIRMED (6-12 confirmations)</h3>
            <pre><code class="language-json">
// Webhook sent - balance IS updated now
{
  "event": "DEPOSIT_CONFIRMED",
  "data": {
    "accountId": "acc_123",
    "amount": "10.0",
    "balance": "10.0",
    "autoSweep": true,
    "txHash": "0x123abc...",
    "confirmations": 6  // Sepolia: 6, Mainnet: 12
  }
}

// Backend updates:
// - balance += 10.0
// - availableBalance += 10.0
// - Triggers auto-sweep if enabled

// Recommended action: Credit user balance, allow withdrawals
            </code></pre>
          </div>

          <div class="border-l-4 border-orange-500 pl-6">
            <h3 class="text-xl font-semibold mb-2">Step 5: Auto-Sweep (if enabled)</h3>
            <pre><code class="language-plaintext">
→ Sweep transaction initiated after DEPOSIT_CONFIRMED
   FROM: 0x742d35Cc (deposit address)
   TO: 0xOMNIBUS... (omnibus address)
   AMOUNT: 10 ETH (minus gas fee ~0.001 ETH)
→ SWEEP_EXECUTED webhook sent
→ Funds consolidated in omnibus wallet
            </code></pre>
          </div>

          <div class="border-l-4 border-gray-500 pl-6">
            <h3 class="text-xl font-semibold mb-2">Step 6: Customer Balance Check</h3>
            <pre><code class="language-json">
// Virtual Account balance updated (database)
{
  "virtualAccountId": "va_abc123",
  "balance": "9.999",  // 10 - 0.001 gas
  "omnibusBalance": "9.999",
  "lastDeposit": {
    "amount": "10.0",
    "txHash": "0x123abc...",
    "timestamp": "2024-12-09T10:30:00Z"
  }
}
            </code></pre>
          </div>

          <div class="border-l-4 border-red-500 pl-6">
            <h3 class="text-xl font-semibold mb-2">Step 5: Webhook Notification</h3>
            <pre><code class="language-json">
// Your server receives webhook
POST https://your-server.com/webhooks/walits
{
  "event": "deposit.confirmed",
  "data": {
    "virtualAccountId": "va_abc123",
    "userId": "user_12345",
    "amount": "10.0",
    "asset": "ETH",
    "txHash": "0x123abc...",
    "confirmations": 1,
    "timestamp": "2024-12-09T10:30:00Z"
  }
}
            </code></pre>
          </div>
        </div>

        <h2 class="text-2xl font-semibold mt-8 mb-4">Deposit Process Timeline</h2>
        <div class="bg-gray-100 p-6 rounded-lg mb-6">
          <ul class="space-y-3">
            <li><strong>Deposit Address Generation</strong>: &lt;1 second (instant API response)</li>
            <li><strong>Deposit Detection</strong>: Within 10 seconds (block polling interval)</li>
            <li><strong>DEPOSIT_DETECTED Webhook</strong>: Upon 1 confirmation</li>
            <li><strong>DEPOSIT_CONFIRMED Webhook</strong>: Upon 6-12 confirmations (network-dependent)</li>
            <li><strong>Auto-Sweep Trigger</strong>: Immediately after DEPOSIT_CONFIRMED (if enabled)</li>
          </ul>
        </div>