<h1 class="text-4xl font-bold mb-6">ì›¹í›… ë³´ì•ˆ</h1>

        <div class="bg-red-50 border-l-4 border-red-500 p-6 mb-6">
          <p class="font-semibold text-lg mb-2">ğŸ”’ í•­ìƒ ì„œëª… ê²€ì¦</p>
          <p>HMAC-SHA256 ì„œëª…ì„ ê²€ì¦í•˜ì§€ ì•Šê³ ëŠ” ì›¹í›… í˜ì´ë¡œë“œë¥¼ ì ˆëŒ€ ì‹ ë¢°í•˜ì§€ ë§ˆì„¸ìš”. ì´ëŠ” ê³µê²©ìê°€ ì…ê¸ˆ/ì¶œê¸ˆì„ ìœ„ì¡°í•˜ëŠ” ê²ƒì„ ë°©ì§€í•©ë‹ˆë‹¤.</p>
        </div>

        <h2 class="text-2xl font-semibold mt-8 mb-4">HMAC-SHA256 ì„œëª… ê²€ì¦</h2>
        <p class="mb-4">Walitsì€ ì›¹í›… ì‹œí¬ë¦¿ì„ ì‚¬ìš©í•˜ì—¬ HMAC-SHA256ìœ¼ë¡œ ëª¨ë“  ì›¹í›… í˜ì´ë¡œë“œì— ì„œëª…í•©ë‹ˆë‹¤. ì„œëª…ì€ ë‹¤ìŒê³¼ ê°™ì´ ê³„ì‚°ë©ë‹ˆë‹¤:</p>

        <div class="bg-gray-900 text-gray-100 p-4 rounded-lg font-mono text-sm mb-6">
          <div class="text-green-400 mb-2">// ì„œëª… ê³µì‹:</div>
          <div>message = timestamp + "." + event + "." + JSON.stringify(data)</div>
          <div>signature = HMAC-SHA256(webhookSecret, message)</div>
        </div>

        <h3 class="text-xl font-semibold mt-6 mb-3">HTTP í—¤ë”</h3>
        <table class="w-full border border-gray-200 mb-6">
          <thead class="bg-gray-50">
            <tr>
              <th class="border border-gray-200 px-4 py-3 text-left">í—¤ë”</th>
              <th class="border border-gray-200 px-4 py-3 text-left">ì„¤ëª…</th>
              <th class="border border-gray-200 px-4 py-3 text-left">ì˜ˆì‹œ</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td class="border border-gray-200 px-4 py-2 font-mono text-sm">X-Walits-Signature</td>
              <td class="border border-gray-200 px-4 py-2">HMAC-SHA256 ì„œëª…</td>
              <td class="border border-gray-200 px-4 py-2 font-mono text-xs">sha256=abc123...</td>
            </tr>
            <tr>
              <td class="border border-gray-200 px-4 py-2 font-mono text-sm">X-Walits-Timestamp</td>
              <td class="border border-gray-200 px-4 py-2">Unix íƒ€ì„ìŠ¤íƒ¬í”„ (ë°€ë¦¬ì´ˆ)</td>
              <td class="border border-gray-200 px-4 py-2 font-mono text-xs">1702345678901</td>
            </tr>
            <tr>
              <td class="border border-gray-200 px-4 py-2 font-mono text-sm">X-Walits-Event</td>
              <td class="border border-gray-200 px-4 py-2">ì´ë²¤íŠ¸ ìœ í˜•</td>
              <td class="border border-gray-200 px-4 py-2 font-mono text-xs">WITHDRAWAL_EXECUTED</td>
            </tr>
          </tbody>
        </table>

        <h3 class="text-xl font-semibold mt-6 mb-3">Node.js/Express ì˜ˆì‹œ</h3>
        <pre><code class="language-javascript">
const crypto = require('crypto');
const express = require('express');

const app = express();
app.use(express.json());

const WEBHOOK_SECRET = process.env.WALITS_WEBHOOK_SECRET;

// ì„œëª… ê²€ì¦ í•¨ìˆ˜
function verifyWebhookSignature(timestamp, event, data, receivedSignature) {
  const message = `${timestamp}.${event}.${JSON.stringify(data)}`;
  const expectedSignature = `sha256=${crypto
    .createHmac('sha256', WEBHOOK_SECRET)
    .update(message)
    .digest('hex')}`;

  return crypto.timingSafeEqual(
    Buffer.from(expectedSignature),
    Buffer.from(receivedSignature)
  );
}

// ì›¹í›… í•¸ë“¤ëŸ¬
app.post('/webhooks/walits', async (req, res) => {
  const signature = req.headers['x-walits-signature'];
  const timestamp = req.headers['x-walits-timestamp'];
  const event = req.headers['x-walits-event'];
  const { data } = req.body;

  // 1. ì„œëª… ê²€ì¦
  if (!verifyWebhookSignature(timestamp, event, data, signature)) {
    console.error('Invalid signature');
    return res.status(401).send('Invalid signature');
  }

  // 2. íƒ€ì„ìŠ¤íƒ¬í”„ ê²€ì¦ (5ë¶„ ì´ìƒ ì˜¤ë˜ëœ ê²ƒ ê±°ë¶€)
  const now = Date.now();
  if (Math.abs(now - parseInt(timestamp)) > 5 * 60 * 1000) {
    console.error('Timestamp too old');
    return res.status(401).send('Timestamp too old');
  }

  // 3. ì´ë²¤íŠ¸ ìœ í˜•ë³„ ì›¹í›… ì²˜ë¦¬
  try {
    switch (event) {
      case 'DEPOSIT_DETECTED':
        await handleDepositDetected(data);
        break;

      case 'DEPOSIT_CONFIRMED':
        await handleDepositConfirmed(data);
        break;

      case 'WITHDRAWAL_REQUESTED':
        await handleWithdrawalRequested(data);
        break;

      case 'WITHDRAWAL_EXECUTED':
        await handleWithdrawalExecuted(data);
        break;

      case 'WITHDRAWAL_CONFIRMED':
        await handleWithdrawalConfirmed(data);
        break;

      case 'WITHDRAWAL_FAILED':
        await handleWithdrawalFailed(data);
        break;

      default:
        console.warn(`Unknown event: ${event}`);
    }

    res.status(200).send('OK');
  } catch (error) {
    console.error('Webhook processing error:', error);
    res.status(500).send('Internal server error');
  }
});

// ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
async function handleDepositDetected(data) {
  console.log('Deposit detected (notification only):', data);
  // UIì— "ë³´ë¥˜ ì¤‘ì¸ ì…ê¸ˆ" í‘œì‹œ
  await updateCustomerUI(data.accountId, {
    status: 'DETECTING',
    amount: data.amount,
    txHash: data.txHash
  });
}

async function handleDepositConfirmed(data) {
  console.log('Deposit confirmed - crediting balance:', data);
  // ê³ ê° ì”ì•¡ í¬ë ˆë”§
  await db.customers.update({
    where: { accountId: data.accountId },
    data: { balance: { increment: parseFloat(data.amount) } }
  });
  await sendNotification(data.accountId, 'Deposit confirmed!');
}

async function handleWithdrawalRequested(data) {
  console.log('Withdrawal requested (balance already held):', data);
  // UI ì—…ë°ì´íŠ¸: "ì¶œê¸ˆ ìš”ì²­ë¨, ìŠ¹ì¸ ëŒ€ê¸° ì¤‘"
  await updateWithdrawalStatus(data.approvalRequestId, 'PENDING');
}

async function handleWithdrawalExecuted(data) {
  console.log('Withdrawal executed (mempool):', data);
  // txHashë¡œ UI ì—…ë°ì´íŠ¸
  await updateWithdrawalStatus(data.approvalRequestId, 'PENDING', data.txHash);
}

async function handleWithdrawalConfirmed(data) {
  console.log('Withdrawal confirmed on-chain:', data);
  // ì™„ë£Œë¡œ í‘œì‹œ
  await updateWithdrawalStatus(data.approvalRequestId, 'CONFIRMED');
  await sendNotification(data.userId, 'Withdrawal completed!');
}

async function handleWithdrawalFailed(data) {
  console.error('Withdrawal failed (balance auto-restored):', data);
  // ê³ ê°ì—ê²Œ ì•Œë¦¼
  await sendNotification(data.userId, `Withdrawal failed: ${data.errorMessage}`);
}

app.listen(3000, () => {
  console.log('Webhook server running on port 3000');
});
        </code></pre>

        <h3 class="text-xl font-semibold mt-6 mb-3">Python ì˜ˆì‹œ</h3>
        <pre><code class="language-python">
import hmac
import hashlib
from flask import Flask, request

app = Flask(__name__)

@app.route('/webhooks/walits', methods=['POST'])
def handle_webhook():
    signature = request.headers.get('X-Walits-Signature')
    webhook_secret = os.environ['WALITS_WEBHOOK_SECRET']
    payload = request.get_data()

    # ì˜ˆìƒ ì„œëª… ê³„ì‚°
    expected_signature = hmac.new(
        webhook_secret.encode('utf-8'),
        payload,
        hashlib.sha256
    ).hexdigest()

    # ì„œëª… ê²€ì¦
    if not hmac.compare_digest(signature, expected_signature):
        print('âŒ Invalid webhook signature!')
        return 'Invalid signature', 401

    # âœ… ì„œëª… ìœ íš¨, ì›¹í›… ì²˜ë¦¬
    event_data = request.get_json()
    event = event_data['event']
    data = event_data['data']

    if event == 'deposit.confirmed':
        # ì‚¬ìš©ì ì”ì•¡ í¬ë ˆë”§
        db.users.update(
            user_id=data['userId'],
            balance=db.users.balance + Decimal(data['amount'])
        )

    return 'OK', 200
        </code></pre>

        <h2 class="text-2xl font-semibold mt-8 mb-4">ëª¨ë²” ì‚¬ë¡€</h2>
        <ul class="list-disc list-inside space-y-2 mb-6">
          <li><strong>HTTPSë§Œ ì‚¬ìš©:</strong> HTTPë¡œ ì „ì†¡ë˜ëŠ” ì›¹í›…ì€ ì¤‘ê°„ì ê³µê²©ì— ì·¨ì•½í•©ë‹ˆë‹¤</li>
          <li><strong>ë©±ë“±ì„± êµ¬í˜„:</strong> Walitsì€ ì¤‘ë³µ ì›¹í›…ì„ ì „ì†¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤; ì²˜ë¦¬ëœ ì´ë²¤íŠ¸ IDë¥¼ ì €ì¥í•˜ì—¬ ì´ì¤‘ í¬ë ˆë”§ì„ ë°©ì§€í•˜ì„¸ìš”</li>
          <li><strong>ë¹ ë¥´ê²Œ 200 ë°˜í™˜:</strong> ì›¹í›…ì„ ë¹„ë™ê¸°ë¡œ ì²˜ë¦¬í•˜ì„¸ìš”; 5ì´ˆ ë‚´ì— ì‘ë‹µí•˜ì§€ ì•Šìœ¼ë©´ Walitsì´ ì¬ì‹œë„í•©ë‹ˆë‹¤</li>
          <li><strong>ì¬ì‹œë„ ë¡œì§:</strong> Walitsì€ ì‹¤íŒ¨í•œ ì›¹í›…(200ì´ ì•„ë‹Œ ì‘ë‹µ)ì„ ì§€ìˆ˜ ë°±ì˜¤í”„ë¡œ ìµœëŒ€ 10íšŒ ì¬ì‹œë„í•©ë‹ˆë‹¤</li>
          <li><strong>IP í™”ì´íŠ¸ë¦¬ìŠ¤íŒ…:</strong> ì›¹í›… ì—”ë“œí¬ì¸íŠ¸ë¥¼ Walits IPë¡œ ì œí•œ: <code>52.1.2.3/32, 54.5.6.7/32</code></li>
        </ul>
