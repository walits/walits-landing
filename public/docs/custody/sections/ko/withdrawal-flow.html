<h1 class="text-4xl font-bold mb-6">출금 플로우</h1>

        <div class="bg-red-50 border-l-4 border-red-500 p-6 mb-6">
          <p class="font-semibold text-lg mb-2">즉시 잔액 홀드</p>
          <p class="mb-3">이중 지출을 방지하기 위해 출금 요청은 <strong>즉시 자금을 잠급니다</strong>:</p>
          <ul class="list-disc list-inside space-y-1">
            <li><code class="bg-red-100 px-2 py-1 rounded">availableBalance</code>가 즉시 감소</li>
            <li><code class="bg-red-100 px-2 py-1 rounded">pendingWithdrawalBalance</code>가 즉시 증가</li>
            <li>동일한 자금에 대한 두 번째 출금 요청은 실패 (사용 가능한 잔액 부족)</li>
            <li>출금이 실패하면 잔액이 자동으로 복원됨 (롤백)</li>
          </ul>
          <p class="mt-3 text-red-800">기술적 세부사항은 <a href="#withdrawal-handling" class="underline">잔액 관리: 출금 처리</a>를 참조하세요.</p>
        </div>

        <h2 class="text-2xl font-semibold mt-8 mb-4">단계별 프로세스</h2>
        <div class="space-y-6">
          <div class="border-l-4 border-blue-500 pl-6">
            <h3 class="text-xl font-semibold mb-2">1단계: 출금 요청 (잔액 홀드)</h3>
            <pre><code class="language-bash">
POST /wallets/custody/{walletId}/withdraw
X-API-Key: bbit_live_xxx
X-API-Secret: sk_xxx

{
  "toAddress": "0xRECIPIENT_ADDRESS",
  "amount": "5.0",
  "memo": "Withdrawal for user_12345"
}

# 응답
{
  "approvalRequestId": "apr_xyz789",
  "status": "PENDING",
  "requiredApprovals": 2,
  "currentApprovals": 0,
  "amount": "5.0",
  "fromAddress": "0xOMNIBUS_ADDRESS",
  "toAddress": "0xRECIPIENT_ADDRESS",
  "message": "Waiting for 2 approvals"
}

# 중요: 잔액 홀드가 즉시 발생
# - availableBalance -= 5.0 (이중 지출 방지)
# - pendingWithdrawalBalance += 5.0
# - WITHDRAWAL_REQUESTED 웹훅 전송
            </code></pre>
          </div>

          <div class="border-l-4 border-green-500 pl-6">
            <h3 class="text-xl font-semibold mb-2">2단계: 정책 검증</h3>
            <pre><code class="language-plaintext">
시스템 확인:
✅ toAddress가 화이트리스트에 있는가? (whitelistOnly = true인 경우)
✅ 일일 한도 확인: 5.0 < 50.0 (maxDailyLimit)
✅ 월간 한도 확인: 5.0 < 2000.0 (maxMonthlyLimit)
✅ 충분한 잔액: 5.0 < 100.0 (옴니버스 잔액)
→ 모든 확인 통과, 승인 워크플로우 시작
            </code></pre>
          </div>

          <div class="border-l-4 border-purple-500 pl-6">
            <h3 class="text-xl font-semibold mb-2">3단계: 승인 프로세스</h3>
            <pre><code class="language-bash">
# 관리자 1 승인
POST /approvals/{approvalRequestId}/approve
X-API-Key: admin1_key
{
  "comment": "Verified with user"
}
→ currentApprovals: 1/2

# 관리자 2 승인
POST /approvals/{approvalRequestId}/approve
X-API-Key: admin2_key
{
  "comment": "Approved"
}
→ currentApprovals: 2/2 ✅
→ 상태: APPROVED
            </code></pre>
          </div>

          <div class="border-l-4 border-orange-500 pl-6">
            <h3 class="text-xl font-semibold mb-2">4단계: MPC 서명 생성</h3>
            <pre><code class="language-plaintext">
→ Walits이 MPC 서명 세레모니 시작
→ 귀사의 키 공유 (1/3) + Walits HSM (1/3) = 2/3 ✅
→ CGGMP24 임계값 서명 생성 (~1.5초)
→ 트랜잭션 구축 및 서명
            </code></pre>
          </div>

          <div class="border-l-4 border-red-500 pl-6">
            <h3 class="text-xl font-semibold mb-2">5단계: 블록체인 브로드캐스트 및 추적</h3>
            <pre><code class="language-json">
// Ethereum에 트랜잭션 브로드캐스트 (walits-provider)
{
  "txHash": "0x789def...",
  "from": "0xOMNIBUS_ADDRESS",
  "to": "0xRECIPIENT_ADDRESS",
  "amount": "5.0 ETH",
  "gasPrice": "30 gwei",
  "status": "pending"
}

// 웹훅: 트랜잭션 확정 (6-12 컨펌 후)
{
  "event": "withdrawal.confirmed",
  "data": {
    "approvalRequestId": "apr_xyz789",
    "txHash": "0x789def...",
    "status": "confirmed",
    "confirmations": 6,  // Sepolia: 6, Mainnet: 12
    "timestamp": "2024-12-09T11:00:00Z"
  }
}
            </code></pre>
          </div>

          <div class="border-l-4 border-gray-500 pl-6">
            <h3 class="text-xl font-semibold mb-2">5.5단계: walits-provider 출금 추적</h3>
            <p class="mb-3">walits-provider는 NestJS로 작성된 RPC Router이자 출금 추적 시스템입니다:</p>
            <ul class="list-disc list-inside space-y-2 mb-3">
              <li><strong>브로드캐스트</strong>: MPC 서명 후 eth_sendRawTransaction으로 트랜잭션 전송</li>
              <li><strong>In-Memory Map</strong>: pending withdrawals를 메모리에 저장</li>
              <li><strong>30초마다 폴링</strong>: eth_getTransactionReceipt로 트랜잭션 상태 조회</li>
              <li><strong>Confirmation 계산</strong>: confirmations = latestBlock - txBlock + 1</li>
              <li><strong>1 conf</strong>: MINED 상태 (로그만 기록, 웹훅 없음)</li>
              <li><strong>6+ conf</strong>: CONFIRMED 상태 (pending balance 차감, 웹훅 전송)</li>
              <li><strong>Revert/Dropped</strong>: FAILED 상태 (잔액 롤백, 웹훅 전송)</li>
            </ul>
          </div>
        </div>

        <h2 class="text-2xl font-semibold mt-8 mb-4">출금 상태</h2>
        <table class="w-full border border-gray-200 mb-6">
          <thead class="bg-gray-50">
            <tr>
              <th class="border border-gray-200 px-4 py-3 text-left">상태</th>
              <th class="border border-gray-200 px-4 py-3 text-left">설명</th>
              <th class="border border-gray-200 px-4 py-3 text-left">다음 조치</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td class="border border-gray-200 px-4 py-2 font-mono text-sm bg-yellow-50">PENDING</td>
              <td class="border border-gray-200 px-4 py-2">승인 대기 중</td>
              <td class="border border-gray-200 px-4 py-2">관리자가 승인 필요</td>
            </tr>
            <tr>
              <td class="border border-gray-200 px-4 py-2 font-mono text-sm bg-blue-50">APPROVED</td>
              <td class="border border-gray-200 px-4 py-2">임계값 충족, 서명 생성 중</td>
              <td class="border border-gray-200 px-4 py-2">자동 (MPC 서명)</td>
            </tr>
            <tr>
              <td class="border border-gray-200 px-4 py-2 font-mono text-sm bg-purple-50">BROADCASTING</td>
              <td class="border border-gray-200 px-4 py-2">블록체인에 트랜잭션 전송됨</td>
              <td class="border border-gray-200 px-4 py-2">컨펌 대기</td>
            </tr>
            <tr>
              <td class="border border-gray-200 px-4 py-2 font-mono text-sm bg-green-50">CONFIRMED</td>
              <td class="border border-gray-200 px-4 py-2">온체인 트랜잭션 확정 (6-12 컨펌)</td>
              <td class="border border-gray-200 px-4 py-2">완료 ✅</td>
            </tr>
            <tr>
              <td class="border border-gray-200 px-4 py-2 font-mono text-sm bg-red-50">REJECTED</td>
              <td class="border border-gray-200 px-4 py-2">관리자가 요청 거부</td>
              <td class="border border-gray-200 px-4 py-2">사용자가 새 요청 생성 필요</td>
            </tr>
          </tbody>
        </table>
